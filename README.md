# MacReleaser

macOS app release automation tool - automate build, sign, notarize, and release process for macOS applications.

## Overview

MacReleaser is a specialized release automation tool focused exclusively on releasing Developer ID signed macOS applications built using Xcode. Inspired by goreleaser, but purpose-built for the macOS app ecosystem.

## Features

- **Build Automation**: Integration with `xcodebuild` for building archives
- **Version Injection**: Automatically sets `CFBundleShortVersionString` and `CFBundleVersion` from git tag and commit count
- **Code Signing & Notarization**: Automated code signing and Apple notarization
- **Distribution Formats**: `.app` bundles, `.dmg` disk images, `.zip` archives
- **Release Notes**: Automatic changelog generation from git history with filtering and grouping
- **Release Management**: GitHub releases with automatic asset uploads
- **Homebrew Integration**: Automatic cask generation and tap management
- **Git State Reporting**: Displays commit, branch, tag, and dirty state at pipeline start
- **Polished Output**: Goreleaser-style hierarchical bullet-point output with duration tracking

## Quick Start

### Installation

```bash
# Build from source
git clone https://github.com/macreleaser/macreleaser.git
cd macreleaser
make install
```

### Homebrew

```bash
brew install macreleaser/tap/macreleaser
```

### GitHub Actions

MacReleaser provides a GitHub Action that sets up macOS code signing, installs the binary, and runs `macreleaser release`:

```yaml
- uses: macreleaser/macreleaser@v1
  with:
    p12-base64: ${{ secrets.P12_BASE64 }}
    p12-password: ${{ secrets.P12_PASSWORD }}
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    APPLE_ID: ${{ secrets.APPLE_ID }}
    APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
    APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
```

See [CI Usage](#ci-usage) for a full workflow example.

### Basic Usage

1. **Generate configuration**:
   ```bash
   macreleaser init
   ```

2. **Edit the configuration** (`.macreleaser.yaml`):
   ```yaml
   project:
     name: "MyApp"
     scheme: "MyApp"
   build:
     configuration: "Release"
   sign:
     identity: "Developer ID Application: Your Name (TEAM_ID)"
   notarize:
      apple_id: env(APPLE_ID)
      team_id: env(TEAM_ID)
      password: env(APPLE_APP_SPECIFIC_PASSWORD)
   ```

3. **Validate configuration**:
   ```bash
   macreleaser check
   ```

4. **Release**:
   ```bash
   macreleaser release
   ```

## Configuration

MacReleaser uses a YAML configuration file (`.macreleaser.yaml`) to define your release process. See the example configuration generated by `macreleaser init` for all available options.

### Environment Variables

MacReleaser supports environment variable substitution using `env(VAR_NAME)` syntax:

```yaml
notarize:
  apple_id: env(APPLE_ID)
  team_id: env(TEAM_ID)
  password: env(APPLE_APP_SPECIFIC_PASSWORD)
```

Notes:
- `env(...)` is only substituted in YAML values (not keys).
- Unset variables are left as literals at config load time and validated when the corresponding pipe runs. This allows commands like `build --skip-notarize` to work without Apple credentials set.
- Multiline values are allowed (for example, with literal blocks).

#### GitHub Token

A `GITHUB_TOKEN` environment variable is required to publish GitHub releases. Any token with `repo` write access works — a classic or fine-grained personal access token, or a GitHub Actions token. If you use the [GitHub CLI](https://cli.github.com/), you can pass its token directly:

```bash
GITHUB_TOKEN=$(gh auth token) macreleaser release
```

### Release Notes

MacReleaser generates release notes from git commit history between tags. The changelog is written to `dist/CHANGELOG.md` and used as the GitHub release body.

```yaml
changelog:
  sort: desc          # "asc" or "desc" (default: desc)
  filters:
    exclude:
      - "^docs:"
      - "^chore:"
      - "^Merge pull request"
  groups:
    - title: Features
      regexp: "^feat:"
      order: 0
    - title: Bug Fixes
      regexp: "^fix:"
      order: 1
    - title: Other Changes
      order: 2          # no regexp = catch-all for unmatched commits
```

- **Filtering**: `exclude` removes matching commits; `include` keeps only matching commits. Both use Go regular expressions.
- **Grouping**: Commits are assigned to the first group whose `regexp` matches. A group without a `regexp` acts as a catch-all. Groups are sorted by `order`.
- **Sorting**: `desc` (default) shows newest commits first; `asc` reverses to oldest first.
- **Disabling**: Set `disable: true` to skip changelog generation entirely.

If no `changelog` section is present, a flat bullet list of all commits is generated.

## Commands

- `macreleaser init` - Generate example configuration
- `macreleaser check` - Validate configuration file
- `macreleaser build` - Build, archive, and package project
  - `--clean` - Remove `dist/` before building
  - `--skip-notarize` - Skip notarization for quick local pipeline validation
- `macreleaser release` - Full release process (build, sign, notarize, archive, GitHub release, Homebrew cask)
  - `--clean` - Remove `dist/` before building
- `macreleaser snapshot` - Test build with snapshot version (`<tag>-SNAPSHOT-<shortcommit>`, or `0.0.0-SNAPSHOT-<shortcommit>` when no tags exist)
  - `--clean` - Remove `dist/` before building
  - `--skip-notarize` - Skip notarization for quick local pipeline validation

All commands support `--debug` for verbose output and `--config` to specify a custom config path.

## CI Usage

The `macreleaser/macreleaser` action sets up code signing, installs the binary, and runs `macreleaser release` by default:

```yaml
name: Release

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: macreleaser/macreleaser@v1
        with:
          p12-base64: ${{ secrets.P12_BASE64 }}
          p12-password: ${{ secrets.P12_PASSWORD }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
```

### Action Inputs

| Input | Required | Default | Description |
|-------|----------|---------|-------------|
| `p12-base64` | yes | — | Base64-encoded `.p12` certificate file |
| `p12-password` | yes | — | Password for the `.p12` file |
| `command` | no | `release` | MacReleaser command to run after setup (set to empty string to skip) |
| `macreleaser-version` | no | `latest` | Version to install (e.g., `v1.0.0`) |

### Preparing the Certificate Secret

Export your Developer ID certificate from Keychain Access as a `.p12` file, then base64-encode it:

```bash
base64 < cert.p12 | pbcopy
```

Add the result as `P12_BASE64` and the export password as `P12_PASSWORD` in your repository secrets.

## Requirements

- macOS 10.15 or later
- Xcode and Xcode Command Line Tools
- Go 1.21 or later (for building)

## Contributing

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## Roadmap

See [`docs/PLAN.md`](docs/PLAN.md) for detailed implementation plans and milestones.
